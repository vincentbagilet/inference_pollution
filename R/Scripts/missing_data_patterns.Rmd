---
title: "Analysis of missing data patterns"
output: 
  html_document:
    theme: simplex
    highlight: pygments
    fig_width: 2
  html_notebook: 
    toc: no
    theme: simplex
    highlight: pygments
author: "Vincent Bagilet, LÃ©o Zabrocki"
date: "July 30, 2020"
---

```{r setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE,
               message = FALSE,
               warning = FALSE)  
```  

```{r include=FALSE}
library(tidyverse)
library(europollution)
library(maps)
library(lubridate)
library(leaflet)

theme_set(theme_minimal())
```

```{r include=FALSE}
load("../Outputs/metadata.Rda")
load("../Outputs/subsample_stations_ids.Rda")

wrangled_metadata <- metadata %>% 
  ep_wrangle_metadata() %>% 
  mutate(
    in_subsample = (station_id %in% subsample_stations_ids)
  ) %>% 
  select(-opening_station, -closing_station,-measurement_type) %>% #I need to withdraw that and fix it in europollution
  distinct() 

load("../Outputs/subsample_PM10.Rda")

data <- subsample_PM10 %>% 
  filter(year(date) > 2012) %>% #I need to investigate why this is the case
  group_by(station_id, pollutant) %>% 
  mutate(
    concentration = ifelse(
      minute(lead(date)) != 0 & is.na(concentration), 
      lead(concentration), 
      concentration
    )
  ) %>% 
  ungroup() %>% 
  filter(minute(date) == 0) %>% #I need to fix this in europollution 
  left_join(wrangled_metadata, by = c("station_id", "country_iso", "sampling_point"))

rm(subsample_PM10)
```

In this document, we analyse missing data patterns in the dataset. The dataset has been obtained as described in the document "Download subsample of pollution data" (*ie* using `europollution` package and downloading data for a random sample of 10% of the stations, from 2013 to 2018). In a first step, we focus on one pollutant only, PM10. The present document is build so that it can be easily modified and recomputed for other pollutants or another sample.

# Location of measurement stations

In order to assess by guesswork the representativity of the subsample drawn, we look at the location of the station selected:

```{r}
map_raster <- map_data("world")

wrangled_metadata %>% 
  filter(longitude < 47 & longitude > -25 & latitude > 35 & latitude < 71) %>% 
  ggplot() +
  geom_point(aes(x = longitude, y = latitude, color = in_subsample), size = .05) +
  # geom_polygon(data = map_raster, 
  #                        aes(x = long, y = lat, group=group), 
  #                        color = "grey", fill = NA) +
  coord_map(projection = "azequidistant") +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Location of stations present in the random subsample considered", x = "", y = "", color = "Station in sample") 
```

The sample seems to cover most of Europe and should therefore be somehow representative. Note that the previous map does not represent the full set of stations. For readability reasons, we considered a zoomed version of the map. For more details, one can refer to the following interactive map. 

```{r}
pal <- colorFactor("Dark2", domain = wrangled_metadata$in_subsample) 
color_in_subsample <- pal(wrangled_metadata$in_subsample)
content <- paste("Station type:", wrangled_metadata$station_type, "<br/>",
                 "Station area:", wrangled_metadata$station_area, "<br/>")

wrangled_metadata %>%
  select(station_id, longitude,latitude, in_subsample, station_area, station_type) %>%
  distinct() %>%
  leaflet() %>%
  addTiles() %>%
  addProviderTiles("Esri.WorldGrayCanvas") %>%
  addCircles(col = color_in_subsample, popup = content, lng = ~longitude, lat = ~latitude) %>%
  addLegend(pal = pal, values = ~wrangled_metadata$in_subsample , title = "Station in sample")
```

We also consider the number of stations per country:

```{r}
nb_station_country <- wrangled_metadata %>% 
  group_by(country_iso) %>% 
  summarise(
    nb_station_country = n(),
    nb_station_country_subsample = sum(in_subsample),
    prop_in_country_whole = n()/nrow(wrangled_metadata),
    prop_in_country_subsample = sum(in_subsample)/sum(wrangled_metadata$in_subsample)
  )

nb_station_country %>% 
  kable(col.names = c("Country ISO", "Number of stations in country", "Number of stations in subsample in country", "Proportion of stations located in this country", "Proportion of stations in the subsample located in this country"))

nb_station_country %>% 
  pivot_longer(starts_with("nb_station"), names_to = "in_sample", values_to = "number") %>% 
  mutate(in_sample = str_sub(in_sample, 12, nchar(in_sample))) %>% 
  ggplot() + 
  geom_point(aes(x = country_iso, y = number, color = in_sample)) +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Number of stations by country in overall sample and subsample", x = "Country", y = "Number of stations", color = "Number in") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

nb_station_country %>% 
  pivot_longer(starts_with("prop_in"), names_to = "in_sample", values_to = "prop") %>% 
  mutate(in_sample = str_sub(in_sample, 17, nchar(in_sample))) %>% 
  ggplot() + 
  geom_point(aes(x = country_iso, y = prop, color = in_sample)) +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Proportion of stations by country in overall sample and subsample", x = "Country", y = "Proportion of stations", color = "Proportion in") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```



# Missing data patterns in the subsample

Here, we investigate whether missing PM10 concentration data varies across different dimentions.

```{r}
# To do so, we will use the following function
hist_missing_by <- function(df, variable_missing, grouping_var, facet_var = NA) {
  graph <- df %>% 
    group_by_(grouping_var, facet_var) %>%
    summarise(share_missing = sum(is.na(.data[[variable_missing]]))/n()) %>%
    arrange(share_missing) %>%
    ggplot() +
    # geom_point(aes(x = grouping_var, y = share_missing), color = "darkBlue") +
    geom_col(aes(x = .data[[grouping_var]], y = share_missing), fill = "darkBlue") +
    labs(title = paste("Share of missing", variable_missing,"data by", grouping_var), x = grouping_var, y = paste("Share of missing", variable_missing,"data")) +
    ylim(0, 1) +
    facet_wrap(facets = facet_var)
  
  # graph <- df %>% 
  #   mutate(missing = is.na(concentration)) %>% 
  #   ggplot() + 
  #   geom_bar(aes(x = .data[[grouping_var]], fill = missing), position = "fill") +
  #   facet_wrap(facet_var) +
  #   labs(title = paste("Share of missing", variable_missing,"data by", grouping_var), x = grouping_var, y = paste("Share of missing", variable_missing,"data")) +
  #   scale_fill_brewer(palette = "Blues")
  
  return(graph)
}
```


## Across countries

```{r include = FALSE}
share_missing <-  sum(is.na(data$concentration))/nrow(data)
```

The overall share of missing value is `r share_missing`.

We can break this down by countries.

```{r fig.height=4, fig.width=4}
missing_share_country <- data %>% 
  group_by(country_iso) %>% 
  summarise(share_missing = sum(is.na(concentration))/n()) %>% 
  arrange(share_missing)

missing_share_country %>% 
  kable()

missing_share_country %>% 
  ggplot() + 
  # geom_point(aes(x = reorder(country_iso, share_missing), y = share_missing), color = "darkBlue") + 
  geom_col(aes(x = reorder(country_iso, share_missing), y = share_missing), fill = "darkBlue") + 
  labs(title = "Share of missing PM10 concentration data by country", x = "Country", y = "Share of missing PM10 concentration data") +
  coord_flip() 
```

One can notice that the share of missing values varies drastically across countries. This can be due to the quality of monitoring of air pollution stations. This variation might also come from our data wrangling. We need to check that.

## Across dates and time

Overall, we notice that, along the time dimension data almost seems to be missing at random appart from a decreasing trend in the proportion of missing data 

```{r}
data %>%  
  mutate(year = factor(year(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "year")
```

One may notice that the share of missing data slightly decreased over time. This might be due to improvement in air measurement capacity.

We look at whether this variation comes from some countries more than others.

```{r}
data %>% 
  mutate(year = year(date)) %>% 
  group_by(country_iso, year) %>% 
  summarise(share_missing = sum(is.na(concentration))/n()) %>% 
  arrange(share_missing) %>% 
  ggplot() + 
  geom_point(aes(x = country_iso, y = share_missing, color = factor(year))) + 
  scale_color_brewer(palette = "Spectral") +
  labs(title = "Share of missing PM10 concentration data by country", x = "Country", y =  "Share of missing PM10 concentration data") +
  ylim(0, 1)
```

Zooming in and looking at monthly data, we can see that this decreasing trend is somehow step wise, with some important decreases between December and January.

```{r}
data %>%  
  mutate(year_month = paste(year(date), str_pad(month(date), 2, pad = 0))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "year_month") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


We now investigate whether the share of missing data varies across month of the year, day of the month and day of the week. There does not seem to be huge variations.

### Month

```{r}
data %>%
  mutate(month = factor(month(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "month")

data %>%  
  mutate(
    year = factor(year(date)), 
    month = factor(month(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "month", facet_var = "year")
```

### Day of the month

```{r}
data %>%
  mutate(day_of_month = factor(day(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month", facet_var = "month")
```

### Day of the week

```{r}
data %>%
  mutate(day_in_week = factor(wday(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week", facet_var = "month")
```


### Hour of the day

Now we investigate whether there are some variation in missingness patterns across time.

```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "hour")
```

One may notice that there is a lot less missing data around 11pm. This might be problematic and needs to be investigated.


```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "hour", facet_var = "country_iso")
```

This pattern seems to be widespread across countries, even though some countries do not seem to be affected.


