---
title: "Analysis of missing data patterns"
output: 
  html_notebook: 
    toc: no
    theme: simplex
    highlight: pygments
  html_document:
    theme: simplex
    highlight: pygments
author: "Vincent Bagilet, LÃ©o Zabrocki"
date: "July 30, 2020"
---

```{r setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE,
               message = FALSE,
               warning = FALSE)  
```  

```{r include=FALSE}
library(tidyverse)
library(mediocrethemes)
library(maps)
library(lubridate)
library(leaflet)

set_mediocre_all()
```

```{r include=FALSE}
metadata_pollution <- readRDS("../Outputs/metadata_air_pollution_stations.RDS")
data <- readRDS("../Outputs/clean_pollution_data.RDS")
raw <- readRDS("../Outputs/raw_air_pollution_data.RDS")
```

In this document, we analyse missing data patterns in the dataset. In a first step, we focus on one pollutant only, PM10. The present document is build so that it can be easily modified and recomputed for other pollutants or another sample.

# Location of measurement stations

The stations considered are located in the 17 biggest largest in France:

```{r}
metadata_pollution %>% 
  count(city) %>% 
  kable(col.names = c("City", "Number of stations"))
```

# Missing data patterns in the subsample

Here, we investigate whether missing pollutant concentration data varies across different dimentions. 

```{r include = FALSE}
share_missing <- sum(is.na(data$concentration))/nrow(data)
```

The overall share of missing value is `r share_missing`.

```{r}
# To do so, we will use the following function
hist_missing_by <- function(df, variable_missing, grouping_var, facet_var = NA) {
  graph <- df %>% 
    group_by_(grouping_var, facet_var) %>%
    summarise(share_missing = sum(is.na(.data[[variable_missing]]))/n()) %>%
    arrange(share_missing) %>%
    ggplot() +
    # geom_point(aes(x = grouping_var, y = share_missing), color = "darkBlue") +
    geom_col(aes(x = .data[[grouping_var]], y = share_missing)) +
    labs(title = paste("Share of missing", variable_missing,"data by", grouping_var), x = grouping_var, y = paste("Share of missing", variable_missing,"data")) +
    ylim(0, 1) +
    facet_wrap(facets = facet_var)
  
  # graph <- df %>% 
  #   mutate(missing = is.na(concentration)) %>% 
  #   ggplot() + 
  #   geom_bar(aes(x = .data[[grouping_var]], fill = missing), position = "fill") +
  #   facet_wrap(facet_var) +
  #   labs(title = paste("Share of missing", variable_missing,"data by", grouping_var), x = grouping_var, y = paste("Share of missing", variable_missing,"data")) +
  #   scale_fill_brewer(palette = "Blues")
  
  return(graph)
}
```


## Across pollutants

We can break this down by pollutant

```{r fig.height=4, fig.width=4}
missing_share_pollutant <- data %>% 
  group_by(pollutant) %>% 
  summarise(share_missing = sum(is.na(concentration))/n()) %>% 
  arrange(share_missing)

missing_share_pollutant %>% 
  kable()

missing_share_pollutant %>% 
  ggplot() + 
  # geom_point(aes(x = reorder(country_iso, share_missing), y = share_missing), color = "darkBlue") + 
  geom_col(aes(x = reorder(pollutant, share_missing), y = share_missing)) + 
  labs(title = "Share of missing PM10 concentration data by pollutant", x = "Pollutant", y = "Share of missing PM10 concentration data") 
```

One can notice that the share of missing values varies across pollutants, up to about a factor two. This higlights the potential necessity of analysing missingness patterns independently across pollutants.

## Across dates and time

Overall, we notice that, along the time dimension data almost seems to be missing at random appart from a decreasing trend in the proportion of missing data 

```{r}
data %>%  
  mutate(year = year(date)) %>% 
  filter(year == 2016) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "year")
```

We look at whether this variation comes more from some pollutants than others.

```{r}
data %>% 
  mutate(year = year(date)) %>% 
  group_by(pollutant, year) %>% 
  summarise(share_missing = sum(is.na(concentration))/n()) %>% 
  arrange(share_missing) %>% 
  ggplot() + 
  geom_col(aes(x = factor(year), y = share_missing, fill = pollutant), position = "dodge") + 
  labs(title = "Share of missing PM10 concentration data by year and pollutant", x = "Year", y =  "Share of missing PM10 concentration data") +
  ylim(0, 1)
```

Zooming in and looking at monthly data, we can see that this decreasing trend is somehow step wise, with some important decreases between December and January.

```{r}
data %>%  
  mutate(year_month = paste(year(date), str_pad(month(date), 2, pad = 0))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "year_month") 
```


We now investigate whether the share of missing data varies across month of the year, day of the month and day of the week. There does not seem to be huge variations.

### Month

```{r}
data %>%
  mutate(month = factor(month(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "month")

data %>%  
  mutate(
    year = factor(year(date)), 
    month = factor(month(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "month", facet_var = "year")
```

### Day of the month

```{r}
data %>%
  mutate(day_of_month = factor(day(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_of_month", facet_var = "month")
```

### Day of the week

```{r}
data %>%
  mutate(day_in_week = factor(wday(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "day_in_week", facet_var = "month")
```


### Hour of the day

Now we investigate whether there are some variation in missingness patterns across time.

```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "hour")
```

One may notice that there is a lot less missing data around 11pm. This might be problematic and needs to be investigated.


```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(variable_missing = "concentration", grouping_var = "hour", facet_var = "pollutant")
```

This pattern seems to be widespread across countries, even though some countries do not seem to be affected.


