---
title: "Analysis of missing data patterns"
author:
  - name: Vincent Bagilet 
    url: https://www.sipa.columbia.edu/experience-sipa/sipa-profiles/vincent-bagilet
    affiliation: Columbia University
    affiliation_url: https://www.columbia.edu/
  - name: LÃ©o Zabrocki 
    url: https://www.parisschoolofeconomics.eu/en/
    affiliation: Paris School of Economics
    affiliation_url: https://www.parisschoolofeconomics.eu/en/
date: "`r Sys.Date()`"
# output: 
#   html_notebook: 
#     toc: no
#     theme: simplex
#     highlight: pygments
#   html_document:
#     theme: simplex
#     highlight: pygments
# ---
output: distill::distill_article
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE,
               message = FALSE,
               warning = FALSE,
               out.width = "70%",
               dpi = 300,
               fig.align = "center")  
```  

```{r include=FALSE}
library(tidyverse)
library(mediocrethemes)
# library(maps)
library(lubridate)
# library(leaflet)

set_mediocre_all()
```

```{r include=FALSE}
metadata_pollution <- readRDS("../Outputs/clean_metadata_pollution.RDS")
data_imputation <- readRDS("../Outputs/data_imputation.RDS")
# raw <- readRDS("../Outputs/raw_air_pollution_data.RDS")
```

In this document, we analyse missing data patterns in the dataset. 

First of all, we noticed that there are some issues with the dataset and therefore, for now, restrict the dataset to get rid off these issues. In particular, we do not have any pollution data for 2014 nor for NO in 2015 and very few observations for PMs in 2019. These issue do not come from actual missing data but are due to issue with the package we used to access the pollution data. These data are available through the EEA interface.

```{r}
data <- data_imputation %>%  
  mutate(year = lubridate::year(date)) %>% 
  filter(year != 2014) %>% 
  filter(!(year == 2015 & pollutant == "no")) %>% 
  filter(!(year == 2019 & str_sub(pollutant, 1, 2) == "pm")) %>% 
  select(-year)
  
rm(data_imputation)
```


# Location of measurement stations

The stations considered are located in the 17 biggest largest in France:

```{r}
metadata_pollution %>% 
  count(city) %>% 
  kable(col.names = c("City", "Number of stations"))
```

# Missing data patterns in the sample

Here, we investigate whether missing pollutant concentration data varies across different dimentions. 

```{r include = FALSE}
share_missing <- sum(is.na(data$concentration))/nrow(data)
```

The overall share of missing values is `r share_missing`.

```{r}
#' Graphs describing the proportion of missing values in different groups
#'
#' Enables to plot the proportion of missing values by a number of 
#'
#' @param df A dataframe. Dataframe to analyse 
#' @param grouping_var A string. Name of the variable, in \code{df}, for which the proportion of missing values needs to be displayed
#' @param bins An integer. Number of bins to slice \code{grouping_var} in, if it is a continuous value.
#' @param facet_var A string. Name of the variable, in \code{df}, by which to facet the initial graph
#' @param y_axis_to An integer. Limit of the y axis
#' @export
#'
hist_missing_by <- function(df, variable_missing = "concentration", grouping_var, bins = 10, facet_var = NA, y_axis_to = 0.3) {
  
  grouping_var_name <- str_replace_all(grouping_var, pattern = "_", replacement = " ")
  variable_missing_name <- str_replace_all(variable_missing, pattern = "_", replacement = " ")
  
  if (!is.factor(df[[grouping_var]]) && !is.logical(df[[grouping_var]])  && !is.na(as.numeric(df[[grouping_var]]))) {
    df[[grouping_var]] <- cut_interval(as.numeric(df[[grouping_var]]), bins)
  } 
  
  graph <- df %>% 
    filter(!is.na(.data[[grouping_var]])) %>% 
    group_by_(grouping_var, facet_var) %>%
    summarise(share_missing = sum(is.na(.data[[variable_missing]]))/n()) %>%
    arrange(share_missing) %>%
    ggplot() +
    # geom_point(aes(x = .data[[grouping_var]], y = share_missing)) +
    # geom_line(aes(x = .data[[grouping_var]], y = share_missing)) +
    geom_col(aes(x = .data[[grouping_var]], y = share_missing)) +
    labs(
      title = paste("Share of missing", variable_missing_name,"data by", grouping_var_name),
      x = str_to_sentence(grouping_var_name), 
      y = paste("Share of missing", variable_missing_name,"data")
    ) 
  
  if (!is.null(y_axis_to)) {
    graph <- graph + 
      ylim(0, y_axis_to) 
  }
   
  if (!is.na(facet_var)) {
    graph <- graph +
    facet_wrap(facets = facet_var)
  } 
  
  return(graph)
}
```


## Across pollutants

We can break this down by pollutant.

```{r}
data %>%
  hist_missing_by(grouping_var = "pollutant") 
```


One can notice that the share of missing values varies across pollutants, up to about a factor two. This higlights the potential necessity of analysing missingness patterns independently across pollutants.

## Across locations

We look weather missingness patterns vary across cities.

```{r}
data %>% 
  hist_missing_by(grouping_var = "city") +
  coord_flip()
```

```{r}
data %>%  
  hist_missing_by(grouping_var = "site_area") 
```

```{r}
data %>%  
  hist_missing_by(grouping_var = "site_type") 
```


```{r}
data %>% 
  hist_missing_by(grouping_var = "elevation") 
```

```{r}
data %>% 
  hist_missing_by(grouping_var = "latitude") 
```


## Across dates and time

Overall, we notice that, along the time dimension data almost seems to be missing at random appart from a decreasing trend in the proportion of missing data 

```{r}
data %>%  
  mutate(year = year(date)) %>% 
  hist_missing_by(grouping_var = "year") 
```

We look at whether this variation comes more from some pollutants than others.

```{r}
data %>% 
  mutate(year = year(date)) %>% 
  group_by(pollutant, year) %>% 
  summarise(share_missing = sum(is.na(concentration))/n()) %>% 
  arrange(share_missing) %>% 
  ggplot() + 
  geom_col(aes(x = factor(year), y = share_missing, fill = pollutant), position = "dodge") + 
  labs(title = "Share of missing PM10 concentration data by year and pollutant", x = "Year", y =  "Share of missing PM10 concentration data") +
  ylim(0, 1)
```

Zooming in and looking at monthly data, we can see that this decreasing trend is somehow step wise, with some important decreases between December and January.

```{r}
data %>%  
  mutate(year_month = paste(year(date), str_pad(month(date), 2, pad = 0))) %>% 
  hist_missing_by(grouping_var = "year_month") 
```


We now investigate whether the share of missing data varies across month of the year, day of the month and day of the week. There does not seem to be huge variations.

### Month

```{r}
data %>%
  mutate(month = factor(month(date))) %>% 
  hist_missing_by(grouping_var = "month")

data %>%  
  mutate(
    year = factor(year(date)), 
    month = factor(month(date))
  ) %>% 
  hist_missing_by(grouping_var = "month", facet_var = "year")
```

### Day of the month

```{r}
data %>%
  mutate(day_of_month = factor(day(date))) %>% 
  hist_missing_by(grouping_var = "day_of_month")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(grouping_var = "day_of_month", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_of_month = factor(day(date))
  ) %>% 
  hist_missing_by(grouping_var = "day_of_month", facet_var = "month")
```

### Day of the week

```{r}
data %>%
  mutate(day_in_week = factor(wday(date))) %>% 
  hist_missing_by(grouping_var = "day_in_week")

data %>%  
  mutate(
    year = factor(year(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(grouping_var = "day_in_week", facet_var = "year")

data %>%  
  mutate(
    month = factor(month(date)), 
    day_in_week = factor(wday(date))
  ) %>% 
  hist_missing_by(grouping_var = "day_in_week", facet_var = "month")
```


### Hour of the day

Now we investigate whether there are some variation in missingness patterns across time.

```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(grouping_var = "hour")
```



```{r}
data %>%
  mutate(hour = factor(hour(date))) %>% 
  hist_missing_by(grouping_var = "hour", facet_var = "pollutant")
```

### School and public holidays

```{r}
data %>%
  hist_missing_by(grouping_var = "public_holiday")
```

```{r}
data %>%
  hist_missing_by(grouping_var = "school_holiday")
```

## Across weather patterns

### Temperature

```{r}
data %>%
  hist_missing_by(grouping_var = "temperature")
```

### Wind

```{r}
data %>% 
  hist_missing_by(grouping_var = "wind_speed")
```

```{r}
data %>% 
  hist_missing_by(grouping_var = "wind_speed_max")
```

```{r}
data %>% 
  hist_missing_by(grouping_var = "wind_direction", y_axis_to = 0.1) +
  coord_polar()
```


```{r}
data %>% 
  hist_missing_by(grouping_var = "wind_direction_max", y_axis_to = 0.1) +
  coord_polar()
```

### Rainfall

```{r}
data %>% 
  hist_missing_by(grouping_var = "rainfall_height") 
```



```{r}
data %>% 
  hist_missing_by(grouping_var = "rainfall_duration") 
```

### Other weather variables

```{r}
data %>% 
  hist_missing_by(grouping_var = "relative_humidity") 
```



```{r}
data %>% 
  hist_missing_by(grouping_var = "sea_level_pressure") 
```


```{r}
data %>% 
  hist_missing_by(grouping_var = "insolation_duration") 
```



```{r}
data %>% 
  hist_missing_by(grouping_var = "global_radiation") 
```



```{r}
data %>% 
  hist_missing_by(grouping_var = "uv_radiation") 
```

## Other

We investigate whether when one pollutant is missing, other pollutants are also missing. We count the number of pollutants which are simultaneously missing for every station*date couple. Note that this analysis does not consider that an observation is missing when a given station is closed for a pollutant.

```{r}
data %>% 
  mutate(missing = is.na(concentration)) %>% 
  group_by(date, site) %>% 
  summarise(nb_missing = sum(missing)) %>% 
  ungroup() %>% 
  count(nb_missing) %>% 
  mutate(prop = n/sum(n)) %>% 
  kable(col.names = c("Number of pollutants with concentration data missing", "Number of dates", "Proportion"))
```

We could also investigate whether this pattern varies with various weather variables.


# Length of periods with missing observations

In this section, we explore the length of periods with missing observations. This length may provide information on the reasons for which data is missing. We also explore whether the length of missingness patterns is correlated with weather variables.

First, we explore the length of missing observations by looking at the displaying, in an heatmat, for each couple station*date, whether concentration data is missing. We break this down into years for readibility. 

```{r heatmap}
data %>% 
  # filter(pollutant == "o3") %>%
  mutate(year = year(date)) %>% 
  filter(year == 2013) %>% 
  mutate(missing = is.na(concentration)) %>% 
  group_by(city) %>% 
  mutate(site_city = paste(city, as.integer(factor(site)), sep = "_")) %>% 
  ungroup() %>% 
  ggplot() +
  geom_tile(aes(x = date, y = site_city, fill = missing)) +
  # theme_minimal() +
  facet_wrap(~ pollutant) +
  scale_fill_viridis_d() + 
  theme(panel.grid.major.x = element_blank()) + 
  labs(title = paste("Intervals with missing concentration data for", pol, "in", y, sep = " "), x = "Date", y =  "Air pollution station") 
```

Then, we look at the length of periods with missing data. First, we can either count each the number of periods with a given length (*eg* 3 periods have a length of missing data of 5 hours) or count the number of dates belonging to periods with a given length (considering the same example, 15 dates belong to a period of missing data of length 5 hours). We denote the former case "One observation per period" and the later "One observation per date".

```{r}
length_missing_data <- data %>% 
  mutate(
    missing = is.na(concentration),
    row_id = row_number()
  ) %>% 
  # select(missing, site, pollutant, date, row_id) %>%
  group_by(site, pollutant) %>%
  arrange(date) %>% 
  mutate(
    missing_period_id = ifelse(missing == TRUE & lag(missing) == FALSE, row_id, NA)
  ) %>%
  filter(missing == TRUE) %>%
  fill(missing_period_id) %>% 
  ungroup() %>% 
  select(-row_id) %>% 
  arrange(missing_period_id) %>% 
  group_by(missing_period_id, pollutant) %>% 
  mutate(length_period_missing = n()) %>% 
  ungroup()

length_missing_one_per_period <- length_missing_data %>% 
  count(missing_period_id, pollutant, name = "length_period_missing")
```

### Distribution of lengths of missing data

```{r}
length_missing_one_per_period %>% 
  ggplot(aes(x = length_period_missing)) +
  geom_histogram(bins = 20) +
  scale_x_continuous(trans = 'log10') +
  facet_wrap(~pollutant) +
  labs(title = "Repartition of the length of periods of missing data", subtitle = "Comparison across pollutants - One observation per period", x = "Number of consecutive hours of missing data", y =  "Count") 

length_missing_one_per_period %>% 
  ggplot(aes(x = length_period_missing)) +
  geom_density(adjust = 4, fill = mediocrethemes::colors_table$base[2], alpha = 0.6) +
  scale_x_continuous(trans = 'log10') +
  facet_wrap(~pollutant) +
  labs(title = "Repartition of the length of periods of missing data", subtitle = "Comparison across pollutants - One observation per period", x = "Number of consecutive hours of missing data", y = "Density") 
```

```{r}
length_missing_data %>% 
  ggplot(aes(x = length_period_missing)) +
  geom_histogram(bins = 20) +
  scale_x_continuous(trans = 'log10') +
  facet_wrap(~pollutant) +
  labs(title = "Repartition of the length of periods of missing data", subtitle = "Comparison across pollutants - One observation per date", x = "Number of consecutive hours of missing data", y =  "Count") 

length_missing_data %>% 
  ggplot(aes(x = length_period_missing)) +
  geom_density(adjust = 2, fill = mediocrethemes::colors_table$base[2], alpha = 0.6) +
  scale_x_continuous(trans = 'log10') +
  facet_wrap(~pollutant) +
  labs(title = "Repartition of the length of periods of missing data", subtitle = "Comparison across pollutants - One observation per date", x = "Number of consecutive hours of missing data", y = "Density") 
```

```{r}
length_missing_one_per_period %>% 
  mutate(missing_longer_day = ifelse(length_period_missing > 24, TRUE, FALSE)) %>% 
  ggplot() +
  geom_histogram(aes(x = missing_longer_day), stat = "count") + 
  labs(title = "Number of periods with missing data longer/shorter than a day", subtitle = "One observation per period", x = "Missing period longer than a day", y =  "Count") 
```

```{r}
length_missing_data %>% 
  mutate(missing_longer_day = ifelse(length_period_missing > 24, TRUE, FALSE)) %>% 
  ggplot() +
  geom_histogram(aes(x = missing_longer_day), stat = "count") + 
  labs(title = "Number of periods with missing data longer/shorter than a day", subtitle = "One observation per date", x = "Missing period longer than a day", y =  "Count") 
```

### Coorelation between missingness length and weather variables

```{r}
plot_evolution_length <- function(var) {
  var_name <- str_replace_all(var, pattern = "_", replacement = " ")
  
  graph <- length_missing_data %>% 
    ggplot() + 
    geom_bin2d(aes(x = .data[[var]], y = .data[["length_period_missing"]])) +
    scale_x_continuous(trans = 'log10') + 
    labs(title = paste("Relationship between length of periods with missing data", var), subtitle = "One observation per date", x = str_to_sentence(var_name), y =  "Length of missing period (in hours)") 
  
  if (substr(var, 1, 8) == "wind_dir") {
    graph <- graph +
      coord_polar()
  }
    
  return(graph)
}
```


```{r}
weather_var <- data %>% 
  select(rainfall_height:uv_radiation) %>% 
  names()

purrr::map(weather_var, plot_evolution_length)
```


