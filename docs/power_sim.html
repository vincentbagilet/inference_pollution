<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
  <title>Estimating Small Effects: Running power simulations</title>

  <meta property="description" itemprop="description" content="In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies."/>

  <link rel="icon" type="image/vnd.microsoft.icon" href="images/site/favicon.ico"/>

  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2024-05-06"/>
  <meta property="article:created" itemprop="dateCreated" content="2024-05-06"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Estimating Small Effects: Running power simulations"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Estimating Small Effects"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Estimating Small Effects: Running power simulations"/>
  <meta property="twitter:description" content="In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","date","output","editor_options"]}},"value":[{"type":"character","attributes":{},"value":["Running power simulations"]},{"type":"character","attributes":{},"value":["In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies."]},{"type":"character","attributes":{},"value":["2024-05-06"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc"]}},"value":[{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["chunk_output_type"]}},"value":[{"type":"character","attributes":{},"value":["console"]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
    font-size: 100%;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  hr.section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    margin: 0px;
  }


  d-byline {
    border-top: none;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
    border-top: none;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  /* tweak for Pandoc numbered line within distill */
  d-article pre.numberSource code > span {
      left: -2em;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // separator
    var separator = '<hr class="section-separator" style="clear: both"/>';
    // prepend separator above appendix
    $('.d-byline').before(separator);
    $('.d-article').before(separator);

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme, except when numbering line
    // in code chunk
    $('pre:not(.numberLines) code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        var author_name = front_matter.authors[i].author
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', author_name ? 'ORCID ID for ' + author_name : 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        const citeChild = $(this).children()[0]
        // Do not process if @xyz has been used without escaping and without bibliography activated
        // https://github.com/rstudio/distill/issues/466
        if (citeChild === undefined) return true

        if (citeChild.nodeName == "D-FOOTNOTE") {
          var fn = citeChild
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          // Could use CSS.escape too here, we insure backward compatibility in navigator
          return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <style type="text/css">
  /* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */



  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       1.06rem;
    --code-size:       14px;
    --aside-size:      12px;
    --fig-cap-size:    13px;
    /*-- Main font colors --*/
    --title-color:     #000000;
    --header-color:    rgba(0, 0, 0, 0.8);
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     rgba(0, 0, 0, 0.6);
    --fig-cap-color:   rgba(0, 0, 0, 0.6);
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    sans-serif;
    --mono-font:       monospace;
    --body-font:       sans-serif;
    --navbar-font:     sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    0.6rem;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       0.8rem;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    18px;
    --contents-size:   13px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --title-size:       18px;
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  .distill-site-footer {
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */
  </style>
  <style type="text/css">
  /* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */
  @import url('https://fonts.googleapis.com/css2?family=Lato');
  @import url('https://fonts.googleapis.com/css2?family=Lora');


  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       1.06rem;
    --code-size:       13px;
    --aside-size:      12px;
    --fig-cap-size:    12px;
    /*-- Main font colors --*/
    --title-color:     rgba(0, 129, 167, 1);
    --header-color:    rgba(0, 129, 167, 1);
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     rgba(0, 0, 0, 0.6);
    --fig-cap-color:   rgba(0, 0, 0, 0.6);
    --hover-color:     rgba(0, 129, 167, 0.6);
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    "Lato", sans-serif;
    --body-font:       "Lora", serif;
    --navbar-font:     "Lato", sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    0.6rem;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       0.8rem;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    18px;
    --contents-size:   13px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --font-family:      'Lato', sans-serif;
    --title-size:       21px;
    --text-color:       rgba(0, 129, 167, 1);
    --text-size:        18px;
    --hover-color:      rgba(0, 129, 167, 0.6);
    --bkgd-color:       rgba(255, 255, 255, 0.8);
    font-variant:       small-caps;
  }

  .nav-dropdown .nav-dropbtn {
    font-variant: small-caps;
  }

  .distill-site-footer {
    --text-color:       rgba(10, 10, 10, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       rgba(240, 240, 240, 0.8); 
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */

  /* Postcard headers */
  h1, h2, h3 {
    color:              rgba(0, 129, 167, 1);
    font-variant:       small-caps;
  }

  p {
    color:              rgba(0, 0, 0, 0.8);
  }

  a {
  	color:              rgba(0, 129, 167, 1);
  }

  a:hover {
  	color:              rgba(0, 129, 167, 0.6);
  }

  /* Buttons on postcard */
  .btn-outline-dark {
      color:            rgba(0, 129, 167, 1);
      border-color:     rgba(0, 129, 167, 1);
  }

  .btn-outline-dark:hover {
      background-color: rgba(0, 129, 167, 1);
      color:            white;
  }

  /*body {
    background-color: rgba(249, 250, 247, 0.8);
  }*/</style>
  <style type="text/css">
  /* base style */

  /* FONT FAMILIES */

  :root {
    --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  body,
  .posts-list .post-preview p,
  .posts-list .description p {
    font-family: var(--body-font), var(--body-default);
  }

  h1, h2, h3, h4, h5, h6,
  .posts-list .post-preview h2,
  .posts-list .description h2 {
    font-family: var(--heading-font), var(--heading-default);
  }

  d-article div.sourceCode code,
  d-article pre code {
    font-family: var(--mono-font), var(--mono-default);
  }


  /*-- TITLE --*/
  d-title h1,
  .posts-list > h1 {
    color: var(--title-color, black);
  }

  d-title h1 {
    font-size: var(--title-size, 50px);
  }

  /*-- HEADERS --*/
  d-article h1,
  d-article h2,
  d-article h3,
  d-article h4,
  d-article h5,
  d-article h6 {
    color: var(--header-color, rgba(0, 0, 0, 0.8));
  }

  /*-- BODY --*/
  d-article > p,  /* only text inside of <p> tags */
  d-article > ul, /* lists */
  d-article > ol {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
    font-size: var(--body-size, 1.06rem);
  }


  /*-- CODE --*/
  d-article div.sourceCode code,
  d-article pre code {
    font-size: var(--code-size, 14px);
  }

  /*-- ASIDE --*/
  d-article aside {
    font-size: var(--aside-size, 12px);
    color: var(--aside-color, rgba(0, 0, 0, 0.6));
  }

  /*-- FIGURE CAPTIONS --*/
  figure .caption,
  figure figcaption,
  .figure .caption {
    font-size: var(--fig-cap-size, 13px);
    color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
  }

  /*-- METADATA --*/
  d-byline h3 {
    font-size: var(--heading-size, 0.6rem);
    color: var(--heading-color, rgba(0, 0, 0, 0.5));
  }

  d-byline {
    font-size: var(--body-size, 0.8rem);
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  d-byline a,
  d-article d-byline a {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  /*-- TABLE OF CONTENTS --*/
  .d-contents nav h3 {
    font-size: var(--heading-size, 18px);
  }

  .d-contents nav a {
    font-size: var(--contents-size, 13px);
  }

  /*-- APPENDIX --*/
  d-appendix h3 {
    font-size: var(--heading-size, 15px);
    color: var(--heading-color, rgba(0, 0, 0, 0.65));
  }

  d-appendix {
    font-size: var(--text-size, 0.8em);
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  d-appendix d-footnote-list a.footnote-backlink {
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  .distill-site-header .title {
    font-size: var(--title-size, 18px);
    font-family: var(--navbar-font), var(--heading-default);
  }

  .distill-site-header a,
  .nav-dropdown .nav-dropbtn {
    font-family: var(--navbar-font), var(--heading-default);
  }

  .nav-dropdown .nav-dropbtn {
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    font-size: var(--text-size, 15px);
  }

  .distill-site-header a:hover,
  .nav-dropdown:hover .nav-dropbtn {
    color: var(--hover-color, white);
  }

  .distill-site-header {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer a:hover {
    color: var(--hover-color, white);
  }</style>
  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.26/header-attrs.js"></script>
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Running power simulations","description":"In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies.","authors":[],"publishedDate":"2024-05-06T00:00:00.000+02:00"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">Estimating Small Effects</a>
</div>
<div class="nav-right">
<a href="inference_pollution_paper.pdf">Paper</a>
<a href="summary.html">Summary</a>
<a href="intuition.html">Intuition</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Literature review
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="std_lit_getting_abstracts.html">Retrieving abstracts from the standard literature</a>
<a href="std_lit_analysis.html">Analysis of the standard literature</a>
<a href="meta_analysis_epi.html">Study of a meta-analysis</a>
<hr/>
<a href="causal_lit_overview.html">Analysis of the causal literature</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Simulations
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="data_wrangling.html">Data wrangling</a>
<a href="data_cleaning.html">Data cleaning</a>
<hr/>
<a href="notes_methodo.html">Overall approach</a>
<a href="power_sim.html">Running the simulations</a>
<a href="sim_results.html">Analysing simulations results</a>
</div>
</div>
<a href="how_to_retro.html">Reporting</a>
<a href="https://github.com/vincentbagilet/inference_pollution" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Running power simulations</h1>

<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p>In this document, we carry out a simulation exercise to evaluate the inference properties of different research designs aiming at measuring the short-term effects of air pollution on health. We consider different types of quasi experiments and for each associate one or several identification strategies.</p>
</div>


<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#function-definitions" id="toc-function-definitions">Function definitions</a>
<ul>
<li><a href="#selecting-the-study-period" id="toc-selecting-the-study-period">Selecting the study period</a></li>
<li><a href="#defining-the-treatment" id="toc-defining-the-treatment">Defining the treatment</a></li>
<li><a href="#creating-fake-output" id="toc-creating-fake-output">Creating fake output</a></li>
<li><a href="#estimating-the-model" id="toc-estimating-the-model">Estimating the model</a></li>
<li><a href="#computing-simulations" id="toc-computing-simulations">Computing simulations</a></li>
</ul></li>
<li><a href="#running-the-simulations" id="toc-running-the-simulations">Running the simulations</a>
<ul>
<li><a href="#defining-baseline-parameters" id="toc-defining-baseline-parameters">Defining baseline parameters</a></li>
<li><a href="#evolution-with-values-of-a-given-parameter" id="toc-evolution-with-values-of-a-given-parameter">Evolution with values of a given parameter</a></li>
<li><a href="#small-number-of-observations" id="toc-small-number-of-observations">Small number of observations</a></li>
<li><a href="#decomposing-the-number-of-observations-into-number-of-cities-and-days" id="toc-decomposing-the-number-of-observations-into-number-of-cities-and-days">Decomposing the number of observations into number of cities and days</a></li>
<li><a href="#decomposing-the-number-of-treated-into-number-of-observations-and-proportion-of-treated" id="toc-decomposing-the-number-of-treated-into-number-of-observations-and-proportion-of-treated">Decomposing the number of treated into number of observations and proportion of treated</a></li>
<li><a href="#usual-values-in-the-literature" id="toc-usual-values-in-the-literature">Usual values in the literature</a></li>
</ul></li>
</ul>
</nav>
</div>
<style>
body {
text-align: justify}
</style>
<p>This document focuses on actually running the simulations. The overall approach to the simulations is described <a href="notes_methodo.html">here</a> and the results are analyzed and discussed <a href="sim_results.html">here</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show the packages used
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='st'><a href='https://groundhogr.com/'>"groundhog"</a></span><span class='op'>)</span></span>
<span><span class='va'>packages</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"here"</span>,</span>
<span>  <span class='st'>"tidyverse"</span>, </span>
<span>  <span class='st'>"knitr"</span>, </span>
<span>  <span class='st'>"broom"</span>,</span>
<span>  <span class='st'>"lubridate"</span>, </span>
<span>  <span class='st'>"tictoc"</span>,</span>
<span>  <span class='st'>"rlang"</span>,</span>
<span>  <span class='st'>"readr"</span>,</span>
<span>  <span class='st'>"fixest"</span>,</span>
<span>  <span class='st'>"Formula"</span>,</span>
<span>  <span class='st'>"furrr"</span>,</span>
<span>  <span class='st'>"progress"</span>,</span>
<span>  <span class='st'>"progressr"</span>,</span>
<span>  <span class='st'>"mediocrethemes"</span></span>
<span>  <span class='co'># "vincentbagilet/mediocrethemes"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># groundhog.library(packages, "2022-11-28")</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>packages</span>, <span class='va'>library</span>, character.only <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://vincentbagilet.github.io/mediocrethemes/reference/set_mediocre_all.html'>set_mediocre_all</a></span><span class='op'>(</span>pal <span class='op'>=</span> <span class='st'>"leo"</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'># Settings for progress bar</span></span>
<span><span class='fu'>handlers</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>  <span class='fu'>handler_progress</span><span class='op'>(</span></span>
<span>    format   <span class='op'>=</span> <span class='st'>":spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta"</span></span>
<span>  <span class='op'>)</span></span>
<span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>nmmaps_data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span></span>
<span>    <span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"simulations"</span>, <span class='st'>"nmmaps_data_simulations.rds"</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>temperature_squared <span class='op'>=</span> <span class='va'>temperature</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h2 id="function-definitions">Function definitions</h2>
<h3 id="selecting-the-study-period">Selecting the study period</h3>
<p>First, we create a function to randomly select a study period of a given length. This function also randomly selects a given number of cities to consider. For simplicity, we choose to have the same temporal study period for each city. This also seems realistic; a study focusing on several cities would probably consider a unique study period.</p>
<p>This function randomly selects a starting date for the study, early enough so that the study can actually last the number of days chosen. It then randomly draws a given number of cities and filters out observations outside of the study period. It returns a data set with only the desired number of cities and days.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>select_study_period</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>n_days</span> <span class='op'>=</span> <span class='fl'>3000</span>, <span class='va'>n_cities</span> <span class='op'>=</span> <span class='fl'>68</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>dates</span> <span class='op'>&lt;-</span> <span class='va'>data</span><span class='op'>[[</span><span class='st'>"date"</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  <span class='va'>err_proof_n_days</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>n_days</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>dates</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='va'>cities</span> <span class='op'>&lt;-</span> <span class='va'>data</span><span class='op'>[[</span><span class='st'>"city"</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  <span class='va'>err_proof_n_cities</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>n_cities</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>cities</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>begin_study</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/seq.Date.html'>seq.Date</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>dates</span><span class='op'>)</span>, </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>dates</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>err_proof_n_days</span>, </span>
<span>      <span class='st'>"day"</span></span>
<span>    <span class='op'>)</span>, <span class='fl'>1</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>dates_kept</span> <span class='op'>&lt;-</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/between.html'>between</a></span><span class='op'>(</span></span>
<span>    <span class='va'>dates</span>, </span>
<span>    <span class='va'>begin_study</span>, </span>
<span>    <span class='va'>begin_study</span> <span class='op'>+</span> <span class='va'>err_proof_n_days</span></span>
<span>  <span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>cities_kept</span> <span class='op'>&lt;-</span> <span class='va'>cities</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>cities</span><span class='op'>)</span>, size <span class='op'>=</span> <span class='va'>err_proof_n_cities</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>data_study</span> <span class='op'>&lt;-</span> <span class='va'>data</span><span class='op'>[</span><span class='op'>(</span><span class='va'>dates_kept</span> <span class='op'>&amp;</span> <span class='va'>cities_kept</span><span class='op'>)</span>,<span class='op'>]</span></span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>data_study</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<h3 id="defining-the-treatment">Defining the treatment</h3>
<p>Then, we create a function to draw the treatment. This function adds a boolean vector to our data, stating whether each observation is in the treatment group or not. The drawing procedure depends on the quasi experiment considered (<code>quasi_exp</code>) and the proportion of treated observations (<code>p_obs_treat</code>). We consider three quasi-experiments:</p>
<ul>
<li>Random days, corresponding to a random allocation of the treatment (<code>random_days</code>)</li>
<li>Air pollution alerts (<code>alert_...</code> with … being the pollutant name )</li>
<li>No quasi-experiment (<code>none</code>)</li>
</ul>
<p>Note that for the alert, we will use RDD to estimate the effect of the treatment. We therefore restrict our sample to observations in a given bandwidth. We draw a threshold position from a uniform distribution from 0.2 to 0.4 in order to have enough observations in our data set. If we pick the threshold position too high up in the distribution of CO concentration, we may end up with observations very far away from the samples. For each city, we find the corresponding threshold and define a bandwidth such that <code>p_obs_treat</code> observations of the total sample are treated. Observations outside the bandwidth get a <code>NA</code> for <code>treated</code>. Thus, after calling this function, we need to filter out observations with a <code>NA</code> for <code>treated</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>draw_treated</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>p_obs_treat</span> <span class='op'>=</span> <span class='fl'>0.5</span>, <span class='va'>quasi_exp</span> <span class='op'>=</span> <span class='st'>"random_days"</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>quasi_exp</span> <span class='op'>==</span> <span class='st'>"random_days"</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/rbernoulli.html'>rbernoulli</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>[[</span><span class='st'>"date"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>, <span class='va'>p_obs_treat</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span> <span class='kw'>else</span> <span class='kw'>if</span> <span class='op'>(</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_starts.html'>str_starts</a></span><span class='op'>(</span><span class='va'>quasi_exp</span>, <span class='st'>"alert"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>pollutant</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_extract.html'>str_extract</a></span><span class='op'>(</span><span class='va'>quasi_exp</span>, <span class='st'>"(?&lt;=_).+"</span><span class='op'>)</span></span>
<span>    <span class='co'># threshold_pos &lt;- rbeta(1, 20, 7) </span></span>
<span>    <span class='va'>threshold_pos</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>0.2</span>, <span class='fl'>0.4</span><span class='op'>)</span> </span>
<span>    <span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>city</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>        threshold <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/quantile.html'>quantile</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span>, <span class='va'>threshold_pos</span>, names <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,</span>
<span>        bw_high <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/quantile.html'>quantile</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>threshold_pos</span> <span class='op'>+</span> <span class='va'>p_obs_treat</span>, <span class='fl'>1</span><span class='op'>)</span>, names <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,</span>
<span>        treated <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span></span>
<span>          <span class='va'>.data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&gt;</span> <span class='va'>bw_high</span> <span class='op'>|</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;</span> <span class='va'>threshold</span> <span class='op'>-</span> <span class='op'>(</span><span class='va'>bw_high</span> <span class='op'>-</span> <span class='va'>threshold</span><span class='op'>)</span>, </span>
<span>          <span class='cn'>NA</span>, </span>
<span>          <span class='op'>(</span><span class='va'>.data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&gt;=</span> <span class='va'>threshold</span><span class='op'>)</span></span>
<span>        <span class='op'>)</span></span>
<span>      <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>bw_high</span>, <span class='op'>-</span><span class='va'>threshold</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span> <span class='kw'>else</span> <span class='op'>{</span></span>
<span>    <span class='va'>data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='cn'>TRUE</span></span>
<span>  <span class='op'>}</span></span>
<span>  </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<p>Both to verify that everything works well and for illustration, we can make quick plots:</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/power_sim/check_draw_treated-1.png" width="85%" style="display: block; margin: auto;" /><img src="images/power_sim/check_draw_treated-2.png" width="85%" style="display: block; margin: auto;" /></p>
</div>
<h3 id="creating-fake-output">Creating fake output</h3>
<p>We then create the fake output, <code>y_fake</code>. The generative process depends on the identification method:</p>
<ul>
<li>For binary treatments, we draw a treatment effect from a Poisson distribution with mean corresponding to the effect size desired.</li>
<li>For the OLS, we build a generative model that creates fake data based on the formula given and with an effect corresponding to the effect size desired.</li>
<li>For the IV, we use the same method as for the OLS but previously, we modified the value of pollutant concentration through the instrument. The instrument is binary and affects pollutant concentration: <span class="math inline">\(Poll_{ct}^{fake} = Poll_{ct} + \delta T_{ct} + e_{ct}\)</span>, where <span class="math inline">\(T_{ct}\)</span> is the treatment dummy, <span class="math inline">\(\delta\)</span> the treatment “intensity” (the <code>iv_strength</code> in our function) and <span class="math inline">\(e \sim \mathcal{N}(0, 0.1)\)</span> a noise.</li>
</ul>
<p>We also create a short function to detect a pollutant among independent variables of a formula. We also use this function later. In the present document we only consider CO but we made the function more general.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>find_pollutant</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>formula</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>pollutants_list</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"co"</span>, <span class='st'>"pm10"</span>, <span class='st'>"pm2.5"</span>, <span class='st'>"no"</span><span class='op'>)</span></span>
<span>    <span class='va'>pollutant</span> <span class='op'>&lt;-</span> <span class='va'>pollutants_list</span><span class='op'>[</span><span class='va'>pollutants_list</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/allnames.html'>all.vars</a></span><span class='op'>(</span><span class='va'>formula</span><span class='op'>)</span><span class='op'>]</span></span>
<span>    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>pollutant</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span>
<span></span>
<span><span class='va'>create_fake_output</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>,</span>
<span>                      <span class='va'>percent_effect_size</span> <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                      <span class='va'>id_method</span> <span class='op'>=</span> <span class='st'>"reduced_form"</span>, </span>
<span>                      <span class='va'>iv_strength</span> <span class='op'>=</span> <span class='cn'>NA</span>, </span>
<span>                      <span class='va'>formula</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='va'>fml</span> <span class='op'>&lt;-</span> <span class='fu'>Formula</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Formula/man/Formula.html'>as.Formula</a></span><span class='op'>(</span><span class='va'>formula</span><span class='op'>)</span></span>
<span>  <span class='va'>dep_var</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/allnames.html'>all.vars</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  </span>
<span>  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"RDD"</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    </span>
<span>    <span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>city</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>        y1 <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>-</span></span>
<span>          <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span></span>
<span>            <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>percent_effect_size</span> <span class='op'>/</span> <span class='fl'>100</span></span>
<span>          <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/warning.html'>suppressWarnings</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='co'>#warnings when is.na(dep_var) eg rpois(1, NA)</span></span>
<span>        y_fake <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"y1"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>*</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>    </span>
<span>  <span class='op'>}</span> <span class='kw'>else</span> <span class='kw'>if</span> <span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"reduced_form"</span><span class='op'>)</span> <span class='op'>{</span></span>
<span></span>
<span>    <span class='co'>#Just a different sign</span></span>
<span>    <span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>city</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>        y1 <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span></span>
<span>          <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span></span>
<span>            <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>percent_effect_size</span> <span class='op'>/</span> <span class='fl'>100</span></span>
<span>          <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/warning.html'>suppressWarnings</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='co'>#warnings when is.na(dep_var) eg rpois(1, NA)</span></span>
<span>        y_fake <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"y1"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>*</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>.data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>    </span>
<span>  <span class='op'>}</span> <span class='kw'>else</span> <span class='kw'>if</span> <span class='op'>(</span><span class='va'>id_method</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"OLS"</span>, <span class='st'>"IV"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>pollutant</span> <span class='op'>&lt;-</span> <span class='fu'>find_pollutant</span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"IV"</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>      <span class='va'>data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> </span>
<span>        <span class='va'>data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> </span>
<span>        <span class='va'>iv_strength</span><span class='op'>*</span><span class='va'>data</span><span class='op'>[[</span><span class='st'>"treated"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span></span>
<span>        <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span>, <span class='fl'>0</span>, <span class='fl'>0.1</span><span class='op'>)</span></span>
<span>      </span>
<span>      <span class='co'>#need to withdraw the first stage from the formula and add the pollutant</span></span>
<span>      <span class='va'>parts_formula</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_split.html'>str_split</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='st'>"\\|"</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span></span>
<span>      <span class='va'>formula_clean</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_c.html'>str_c</a></span><span class='op'>(</span></span>
<span>        <span class='va'>parts_formula</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>, </span>
<span>        <span class='st'>"+"</span>, <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_extract.html'>str_extract</a></span><span class='op'>(</span><span class='va'>parts_formula</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span>, <span class='st'>"\\b.+(?=~)"</span><span class='op'>)</span>,</span>
<span>        <span class='st'>"|"</span>, <span class='va'>parts_formula</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>}</span> <span class='kw'>else</span> <span class='op'>{</span></span>
<span>      <span class='va'>formula_clean</span> <span class='op'>&lt;-</span> <span class='va'>formula</span></span>
<span>    <span class='op'>}</span></span>
<span>    </span>
<span>    <span class='va'>fml</span> <span class='op'>&lt;-</span> <span class='fu'>Formula</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Formula/man/Formula.html'>as.Formula</a></span><span class='op'>(</span><span class='va'>formula_clean</span><span class='op'>)</span></span>
<span>    <span class='va'>reg</span> <span class='op'>&lt;-</span> <span class='fu'>feols</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>data</span>, fml <span class='op'>=</span> <span class='va'>fml</span>, combine.quick<span class='op'>=</span><span class='cn'>FALSE</span><span class='op'>)</span></span>
<span>    <span class='va'>reg</span><span class='op'>$</span><span class='va'>coefficients</span><span class='op'>[[</span><span class='va'>pollutant</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span><span class='op'>*</span><span class='va'>percent_effect_size</span><span class='op'>/</span><span class='fl'>100</span>  </span>
<span>    <span class='co'>#to get beta as the increase in percent</span></span>
<span>    <span class='va'>res</span> <span class='op'>&lt;-</span> <span class='va'>reg</span><span class='op'>$</span><span class='va'>residuals</span></span>
<span>    </span>
<span>    <span class='va'>data</span><span class='op'>[[</span><span class='st'>"y_fake"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>reg</span>, <span class='va'>data</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>res</span>, <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>, sd <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span><span class='op'>)</span></span>
<span>    <span class='co'># data[["y1"]] &lt;- ifelse(data[["y1"]] &lt; 0, 0, data[["y1"]])</span></span>
<span>  <span class='op'>}</span> </span>
<span>  </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span></span>
<span><span class='op'>}</span> </span></code></pre>
</div>
</div>
<p>The proportion of treated observations corresponds to the ratio of the number of orange dots and the total number of dots.</p>
<h3 id="estimating-the-model">Estimating the model</h3>
<p>We can then estimate our model and retrieve the point estimate, p-value, standard error, number of observations and f-stat.
The model should be specified in a three part formula as follows: y ~ x | fixed effects | endo_var ~ instrument. If one does not want to set fixed effects, a 0 should be put in the second part of the formula: y ~ x | 0 | endo_var ~ instrument.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>estimate_model</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>formula</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>fml</span> <span class='op'>&lt;-</span> <span class='fu'>Formula</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Formula/man/Formula.html'>as.Formula</a></span><span class='op'>(</span><span class='va'>formula</span><span class='op'>)</span></span>
<span>  <span class='va'>pasted_formula</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span>, <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span>, <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='co'>#the param of interest varies across identification methods</span></span>
<span>  <span class='va'>param_of_interest</span> <span class='op'>&lt;-</span> </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_count.html'>str_count</a></span><span class='op'>(</span><span class='va'>pasted_formula</span>, <span class='st'>"\\|"</span><span class='op'>)</span> <span class='op'>==</span> <span class='fl'>2</span>, <span class='co'>#if IV (ie 3 parts rhs in formula)</span></span>
<span>           <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_c.html'>str_c</a></span><span class='op'>(</span><span class='st'>"fit"</span>, <span class='fu'>find_pollutant</span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span>, sep <span class='op'>=</span> <span class='st'>"_"</span><span class='op'>)</span>, </span>
<span>           <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='st'>"treated"</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/allnames.html'>all.vars</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span>, <span class='st'>"treatedTRUE"</span>, <span class='fu'>find_pollutant</span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='co'>#run the estimation</span></span>
<span>  <span class='va'>est_results</span> <span class='op'>&lt;-</span> <span class='fu'>feols</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>data</span>, fml <span class='op'>=</span> <span class='va'>fml</span>, se <span class='op'>=</span> <span class='st'>"hetero"</span><span class='op'>)</span> </span>
<span>  </span>
<span>  <span class='co'>#retrieve the useful info</span></span>
<span>  <span class='va'>nobs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>est_results</span><span class='op'>$</span><span class='va'>residuals</span><span class='op'>)</span></span>
<span>  <span class='va'>fstat</span> <span class='op'>&lt;-</span> <span class='fu'>fitstat</span><span class='op'>(</span><span class='va'>est_results</span>, type <span class='op'>=</span> <span class='st'>"ivf"</span><span class='op'>)</span><span class='op'>$</span><span class='va'>ivf1</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/as_vector.html'>as_vector</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='va'>.</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  </span>
<span>  <span class='va'>est_results</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span>conf.int <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>term</span> <span class='op'>==</span> <span class='va'>param_of_interest</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>p_value <span class='op'>=</span> <span class='va'>p.value</span>, se <span class='op'>=</span> <span class='va'>std.error</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='va'>p_value</span>, <span class='va'>se</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      n_obs <span class='op'>=</span> <span class='va'>nobs</span>,</span>
<span>      f_stat <span class='op'>=</span> <span class='va'>fstat</span></span>
<span>    <span class='op'>)</span></span>
<span><span class='op'>}</span>   </span>
<span><span class='co'># estimate_model(draw_treated(nmmaps_data), "death_total ~  temperature + temperature_squared | city + month^year + weekday | co ~ treated")</span></span></code></pre>
</div>
</div>
<h3 id="computing-simulations">Computing simulations</h3>
<p>Before running all these functions together to compute one simulation, we need to compute the true effect. The different identification methods aims to identify different estimands (ATE or ATET). We therefore write a short function to compute this true effect.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>compute_true_effect</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>id_method</span>, <span class='va'>percent_effect_size</span>, <span class='va'>dep_var</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>id_method</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"OLS"</span>, <span class='st'>"IV"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>true_effect</span> <span class='op'>&lt;-</span> <span class='va'>percent_effect_size</span><span class='op'>/</span><span class='fl'>100</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span> <span class='kw'>else</span> <span class='op'>{</span><span class='co'>#ATE</span></span>
<span>    <span class='va'>true_effect</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>y1</span> <span class='op'>-</span> <span class='va'>data</span><span class='op'>$</span><span class='va'>y0</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span></span>
<span>  </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>true_effect</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<p>We can now create a function running all the previous functions together and therefore performing an iteration of the simulation, for a given set of parameters. This function returns a one row data set with estimate, p-value, number of observations and true effect size.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>compute_simulation</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>,</span>
<span>                               <span class='va'>n_days</span> <span class='op'>=</span> <span class='fl'>3000</span>,</span>
<span>                               <span class='va'>n_cities</span> <span class='op'>=</span> <span class='fl'>68</span>, </span>
<span>                               <span class='va'>p_obs_treat</span> <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                               <span class='va'>percent_effect_size</span> <span class='op'>=</span> <span class='fl'>1</span>,</span>
<span>                               <span class='va'>quasi_exp</span> <span class='op'>=</span> <span class='st'>"random_days"</span>,</span>
<span>                               <span class='va'>id_method</span> <span class='op'>=</span> <span class='st'>"reduced_form"</span>, </span>
<span>                               <span class='va'>iv_strength</span> <span class='op'>=</span> <span class='cn'>NA</span>,</span>
<span>                               <span class='va'>formula</span> <span class='op'>=</span> <span class='st'>"resp_total ~ treated"</span>,</span>
<span>                               <span class='va'>progressbar</span> <span class='op'>=</span> <span class='fu'>progressor</span><span class='op'>(</span><span class='op'>)</span><span class='co'>#to have a progressbar when mapping</span></span>
<span>                               <span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='va'>fml</span> <span class='op'>&lt;-</span> <span class='fu'>Formula</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Formula/man/Formula.html'>as.Formula</a></span><span class='op'>(</span><span class='va'>formula</span><span class='op'>)</span></span>
<span>  <span class='va'>dep_var</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/allnames.html'>all.vars</a></span><span class='op'>(</span><span class='va'>fml</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span></span>
<span></span>
<span>  <span class='va'>sim_data</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'>select_study_period</span><span class='op'>(</span><span class='va'>n_days</span>, <span class='va'>n_cities</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>y0 <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>dep_var</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'>draw_treated</span><span class='op'>(</span><span class='va'>p_obs_treat</span>, <span class='va'>quasi_exp</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'>create_fake_output</span><span class='op'>(</span><span class='va'>percent_effect_size</span>, <span class='va'>id_method</span>, <span class='va'>iv_strength</span>, <span class='va'>formula</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>treated</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#not necessary bc dropped in lm()</span></span>
<span>  </span>
<span>  <span class='va'>updated_fml</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_replace.html'>str_replace</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='va'>dep_var</span>, <span class='st'>"y_fake"</span><span class='op'>)</span></span>
<span></span>
<span>  <span class='va'>sim_output</span> <span class='op'>&lt;-</span> <span class='va'>sim_data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'>estimate_model</span><span class='op'>(</span>formula <span class='op'>=</span> <span class='va'>updated_fml</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      true_effect <span class='op'>=</span> <span class='fu'>compute_true_effect</span><span class='op'>(</span></span>
<span>        <span class='va'>sim_data</span>, </span>
<span>        <span class='va'>id_method</span>, </span>
<span>        <span class='va'>percent_effect_size</span>, </span>
<span>        <span class='va'>dep_var</span></span>
<span>      <span class='op'>)</span>,</span>
<span>      n_days <span class='op'>=</span> <span class='va'>n_days</span>, </span>
<span>      n_cities <span class='op'>=</span> <span class='va'>n_cities</span>,</span>
<span>      p_obs_treat <span class='op'>=</span> <span class='va'>p_obs_treat</span>,</span>
<span>      percent_effect_size <span class='op'>=</span> <span class='va'>percent_effect_size</span>,</span>
<span>      quasi_exp <span class='op'>=</span> <span class='va'>quasi_exp</span>,</span>
<span>      id_method <span class='op'>=</span> <span class='va'>id_method</span>, </span>
<span>      iv_strength <span class='op'>=</span> <span class='va'>iv_strength</span>,</span>
<span>      formula <span class='op'>=</span> <span class='va'>formula</span></span>
<span>    <span class='op'>)</span></span>
<span>  </span>
<span>  <span class='fu'>progressbar</span><span class='op'>(</span><span class='op'>)</span> </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>sim_output</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span>
<span></span>
<span><span class='va'>nmmaps_data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'>compute_simulation</span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>.</span>,</span>
<span>    formula <span class='op'>=</span> <span class='st'>"death_total ~ treated + co + temperature + temperature_squared | city + month^year + weekday"</span>,</span>
<span>    quasi_exp <span class='op'>=</span> <span class='st'>"alert_co"</span>,</span>
<span>    id_method <span class='op'>=</span> <span class='st'>"RDD"</span>,</span>
<span>    iv_strength <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>    n_days <span class='op'>=</span> <span class='fl'>1000</span>,</span>
<span>    n_cities <span class='op'>=</span> <span class='fl'>10</span>,</span>
<span>    percent_effect_size <span class='op'>=</span> <span class='fl'>1</span>,</span>
<span>    p_obs_treat <span class='op'>=</span> <span class='fl'>0.5</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 1 × 14
  estimate p_value    se n_obs f_stat true_effect n_days n_cities
     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;lgl&gt;        &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
1   -0.329  0.0437 0.163  7261 NA          -0.174   1000       10
# ℹ 6 more variables: p_obs_treat &lt;dbl&gt;, percent_effect_size &lt;dbl&gt;,
#   quasi_exp &lt;chr&gt;, id_method &lt;chr&gt;, iv_strength &lt;dbl&gt;,
#   formula &lt;chr&gt;</code></pre>
</div>
<p>We will then loop this function to get a large number of replications of each simulation for a given set of parameters. We will also vary the values of the different parameter.</p>
<h2 id="running-the-simulations">Running the simulations</h2>
<p>Before running the simulations, we need to define the set of parameters to consider.</p>
<h3 id="defining-baseline-parameters">Defining baseline parameters</h3>
<p>We will create a table displaying in each row a set of parameters we want to have a simulation for, <code>sim_param_evol</code>. We will then map our function <code>compute_simulation</code> on this table.</p>
<p>To build <code>sim_param_evol</code>, we first define a set of baseline values for our parameters and store them in a data frame, <code>sim_param_base</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_base</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  n_days <span class='op'>=</span> <span class='fl'>2500</span>,</span>
<span>  n_cities <span class='op'>=</span> <span class='fl'>40</span>,</span>
<span>  p_obs_treat <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  percent_effect_size <span class='op'>=</span> <span class='fl'>1</span>, </span>
<span>  iv_strength <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  formula <span class='op'>=</span> <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(sim_param_base, "R/Outputs/sim_param_base.RDS")</span></span>
<span><span class='co'># write_csv(sim_param_base, "R/Outputs/sim_param_base.csv")</span></span></code></pre>
</div>
</div>
<h3 id="evolution-with-values-of-a-given-parameter">Evolution with values of a given parameter</h3>
<h4 id="defining-parameters">Defining parameters</h4>
<p>In a first set of simulation, we vary the values of the parameters one after the other. We thus create vectors containing the different values of the parameters we want to test.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>vect_n_days</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>100</span>, <span class='fl'>500</span>, <span class='fl'>1000</span>, <span class='fl'>2000</span>, <span class='fl'>3000</span>, <span class='fl'>4000</span><span class='op'>)</span></span>
<span><span class='va'>vect_p_obs_treat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.01</span>, <span class='fl'>0.025</span>, <span class='fl'>0.05</span>, <span class='fl'>0.1</span>, <span class='fl'>0.25</span>, <span class='fl'>0.5</span><span class='op'>)</span></span>
<span><span class='va'>vect_percent_effect_size</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.5</span>, <span class='fl'>1</span>, <span class='fl'>2</span>, <span class='fl'>5</span>, <span class='fl'>10</span><span class='op'>)</span></span>
<span><span class='va'>vect_iv_strength</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.01</span>, <span class='fl'>0.1</span>, <span class='fl'>0.2</span>, <span class='fl'>0.5</span>, <span class='fl'>0.7</span><span class='op'>)</span></span>
<span><span class='va'>vect_formula</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='co'># "death_total ~ treated",</span></span>
<span>  <span class='st'>"resp_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span>,</span>
<span>  <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span>,</span>
<span>  <span class='st'>"copd_age_65_75 ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We then want to create the actual table, varying the parameters one after the other. To do so, we create a simple function <code>add_values_param</code>. This function adds the values of a parameter contained in a vector. We can then loop this function on all the vectors of parameters of interest.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'>#adds all values in vect_param</span></span>
<span><span class='va'>add_values_param</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>vect_param</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>param_name</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove</a></span><span class='op'>(</span><span class='va'>vect_param</span>, <span class='st'>"vect_"</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>tib_param</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/get.html'>get</a></span><span class='op'>(</span><span class='va'>vect_param</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>tib_param</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>param_name</span></span>
<span>  </span>
<span>  <span class='va'>df</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>full_join</a></span><span class='op'>(</span><span class='va'>tib_param</span>, by <span class='op'>=</span> <span class='va'>param_name</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, .direction <span class='op'>=</span> <span class='st'>"downup"</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span>
<span></span>
<span><span class='va'>vect_of_vect_param</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"vect_n_days"</span>, </span>
<span>  <span class='st'>"vect_p_obs_treat"</span>, </span>
<span>  <span class='st'>"vect_percent_effect_size"</span>, </span>
<span>  <span class='st'>"vect_iv_strength"</span>, </span>
<span>  <span class='st'>"vect_formula"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_unique</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map_dfr.html'>map_dfr</a></span><span class='op'>(</span></span>
<span>    <span class='va'>vect_of_vect_param</span>, </span>
<span>    <span class='va'>add_values_param</span>, </span>
<span>    df <span class='op'>=</span> <span class='va'>sim_param_base</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> <span class='co'>#bc base parameters appear twice</span></span></code></pre>
</div>
</div>
<p>We want to compute our simulations for this set of parameters for every identification method so we replicate this set of parameters for each identification method (and add information about the associated quasi-experiment). Then, in order to identify the effect of interest, we need to consider different types of equations, depending on the identification method considered. For each set of parameters we want to run many iterations of the simulation so we replicate the dataset <code>n_iter</code> times. It will enable us to loop <code>compute_simulation</code> directly on <code>sim_param_evol</code>.</p>
<p>Note that we make a bunch of small modification to have more realistic parameters. For instance, we only consider small proportions of treated observations for the RDD.</p>
<p>We wrap all this into a function, <code>prepare_sim_param</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>prepare_sim_param</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df_sim_param</span>, </span>
<span>                              <span class='va'>vect_id_methods</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"reduced_form"</span>, <span class='st'>"RDD"</span>, <span class='st'>"OLS"</span>, <span class='st'>"IV"</span><span class='op'>)</span>, </span>
<span>                              <span class='va'>n_iter</span> <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='va'>sim_param_clean</span> <span class='op'>&lt;-</span> <span class='va'>df_sim_param</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span><span class='va'>vect_id_methods</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>id_method <span class='op'>=</span> <span class='va'>vect_id_methods</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      quasi_exp <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>        <span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"reduced_form"</span> <span class='op'>~</span> <span class='st'>"random_days"</span>,</span>
<span>        <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_starts.html'>str_starts</a></span><span class='op'>(</span><span class='va'>id_method</span>, <span class='st'>"RDD"</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>"alert_co"</span>,</span>
<span>        <span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"OLS"</span> <span class='op'>~</span> <span class='st'>"none"</span>,</span>
<span>        <span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"IV"</span> <span class='op'>~</span> <span class='st'>"random_days"</span>,</span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      formula <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>        <span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"OLS"</span> <span class='op'>~</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_replace.html'>str_replace_all</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='st'>"treated"</span>, <span class='st'>"co"</span><span class='op'>)</span>,</span>
<span>        <span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"IV"</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span></span>
<span>          <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove_all</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='st'>"(\\+\\s)?\\btreated\\b(\\s\\+)?"</span><span class='op'>)</span>,</span>
<span>          <span class='st'>"| co ~ treated"</span></span>
<span>          <span class='op'>)</span>,</span>
<span>        <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='va'>formula</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_detect.html'>str_detect</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='st'>"~\\s{0,2}\\|"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='co'>#adapting parameters</span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      p_obs_treat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"RDD"</span>, <span class='va'>p_obs_treat</span><span class='op'>/</span><span class='fl'>5</span>, <span class='va'>p_obs_treat</span><span class='op'>)</span>,</span>
<span>      p_obs_treat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"OLS"</span>, <span class='cn'>NA</span>, <span class='va'>p_obs_treat</span><span class='op'>)</span>,</span>
<span>      iv_strength <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>!=</span> <span class='st'>"IV"</span>, <span class='cn'>NA</span>, <span class='va'>iv_strength</span><span class='op'>)</span></span>
<span>    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='co'>#to erase the duplicates due to iv_strength in non-iv id_methods</span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>id_method</span>, <span class='va'>n_days</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>rep_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_iter</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>rep_id</span><span class='op'>)</span> </span>
<span>  </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>sim_param_clean</span><span class='op'>)</span></span>
<span><span class='op'>}</span> </span>
<span></span>
<span><span class='va'>sim_param_evol</span> <span class='op'>&lt;-</span> <span class='fu'>prepare_sim_param</span><span class='op'>(</span><span class='va'>sim_param_unique</span>, n_iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># write_csv(sim_param, "../Outputs/sim_param.csv")</span></span></code></pre>
</div>
</div>
<h4 id="running-the-simulation">Running the simulation</h4>
<p>We can then run the simulations for each set of parameter, using a <code>pmap_dfr</code> function. We wrote a function to do that while saving intermediary outcomes (every <code>save_every</code> iteration). <code>name_save</code> is the name to use to save an intermediary outcome (to which we add <code>_intermediary</code> and the iteration number).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>run_all_sim</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>sim_param</span>, <span class='va'>save_every</span>, <span class='va'>name_save</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span></span>
<span>  <span class='fu'>future</span><span class='fu'>::</span><span class='fu'><a href='https://future.futureverse.org/reference/plan.html'>plan</a></span><span class='op'>(</span><span class='va'>multisession</span>, workers <span class='op'>=</span> <span class='fu'>availableCores</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='fu'>tic</span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>ceiling</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>sim_param</span><span class='op'>)</span><span class='op'>/</span><span class='va'>save_every</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>params_slice</span> <span class='op'>&lt;-</span> <span class='va'>sim_param</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='va'>save_every</span><span class='op'>*</span><span class='op'>(</span><span class='va'>i</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>save_every</span><span class='op'>*</span><span class='va'>i</span><span class='op'>)</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='fu'>with_progress</span><span class='op'>(</span><span class='op'>{</span></span>
<span>      <span class='va'>p</span> <span class='op'>&lt;-</span> <span class='fu'>progressor</span><span class='op'>(</span>steps <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>params_slice</span><span class='op'>)</span>, on_exit <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span></span>
<span>      </span>
<span>      <span class='va'>intermediary_output</span> <span class='op'>&lt;-</span> <span class='fu'>future_pmap_dfr</span><span class='op'>(</span></span>
<span>        <span class='va'>params_slice</span>,</span>
<span>        <span class='va'>compute_simulation</span>,</span>
<span>        data <span class='op'>=</span> <span class='va'>data</span>,</span>
<span>        progressbar <span class='op'>=</span> <span class='va'>p</span>,</span>
<span>        .options <span class='op'>=</span> <span class='fu'>furrr_options</span><span class='op'>(</span>seed <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>}</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='st'>"Iteration ="</span>, <span class='va'>i</span><span class='op'>*</span><span class='va'>save_every</span><span class='op'>)</span><span class='op'>)</span></span>
<span>    <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='va'>output</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>intermediary_output</span><span class='op'>)</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>saveRDS</a></span><span class='op'>(</span></span>
<span>      <span class='va'>intermediary_output</span>, </span>
<span>      <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"simulations"</span>, <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_c.html'>str_c</a></span><span class='op'>(</span><span class='va'>name_save</span>, <span class='st'>"_intermediary_"</span>, <span class='va'>i</span><span class='op'>*</span><span class='va'>save_every</span>,<span class='st'>".RDS"</span><span class='op'>)</span><span class='op'>)</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>}</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/groundhog/man/toc.html'>toc</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>output</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_evol_large</span> <span class='op'>&lt;-</span> <span class='fu'>run_all_sim</span><span class='op'>(</span><span class='va'>nmmaps_data</span>, <span class='va'>sim_param_evol</span>, save_every <span class='op'>=</span> <span class='fl'>10000</span>, <span class='st'>"sim_evol"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># beepr::beep(1)</span></span>
<span></span>
<span><span class='co'># saveRDS(sim_evol_large, here("R", "Outputs", "sim_evol_large.RDS"))</span></span></code></pre>
</div>
</div>
<h4 id="summarising-the-results">Summarising the results</h4>
<p>We then build the function <code>summarise_simulations</code> to summarize our results, computing power, type M and so on for each set of parameters. Note that this function can only take as input a data frame produced by <code>compute_simulation</code> (or a mapped version of this function).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>summarise_simulations</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      CI_low <span class='op'>=</span> <span class='va'>estimate</span> <span class='op'>+</span> <span class='va'>se</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='fl'>0.95</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span>,</span>
<span>      CI_high <span class='op'>=</span> <span class='va'>estimate</span> <span class='op'>-</span> <span class='va'>se</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='fl'>0.95</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span>,</span>
<span>      length_CI <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>CI_high</span> <span class='op'>-</span> <span class='va'>CI_low</span><span class='op'>)</span>,</span>
<span>      covered <span class='op'>=</span> <span class='op'>(</span><span class='va'>true_effect</span> <span class='op'>&gt;</span> <span class='va'>CI_low</span> <span class='op'>&amp;</span> <span class='va'>true_effect</span> <span class='op'>&lt;</span> <span class='va'>CI_high</span><span class='op'>)</span>, </span>
<span>      covered_signif <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>p_value</span> <span class='op'>&gt;</span> <span class='fl'>0.05</span>, <span class='cn'>NA</span>, <span class='va'>covered</span><span class='op'>)</span> <span class='co'>#to consider only significant estimates</span></span>
<span>    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='va'>quasi_exp</span>, <span class='va'>n_days</span>, <span class='va'>n_cities</span>, <span class='va'>p_obs_treat</span>, <span class='va'>percent_effect_size</span>, <span class='va'>id_method</span>, <span class='va'>iv_strength</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarise</a></span><span class='op'>(</span></span>
<span>      power <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>p_value</span> <span class='op'>&lt;=</span> <span class='fl'>0.05</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>100</span>, </span>
<span>      type_m <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>p_value</span> <span class='op'>&lt;=</span> <span class='fl'>0.05</span>, <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>/</span><span class='va'>true_effect</span><span class='op'>)</span>, <span class='cn'>NA</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>,</span>
<span>      type_s <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>p_value</span> <span class='op'>&lt;=</span> <span class='fl'>0.05</span>, <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>!=</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>true_effect</span><span class='op'>)</span>, <span class='cn'>NA</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>100</span>,</span>
<span>      coverage_rate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>covered_signif</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>100</span>,</span>
<span>      coverage_rate_all <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>covered</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>100</span>,</span>
<span>      <span class='co'># mse = mean((estimate - true_effect)^2, na.rm = TRUE),</span></span>
<span>      <span class='co'># normalized_bias = mean(abs((estimate - true_effect/true_effect)), na.rm = TRUE),</span></span>
<span>      <span class='co'># estimate_true_ratio = mean(abs(estimate/true_effect), na.rm = TRUE),</span></span>
<span>      mean_f_stat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>f_stat</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>,</span>
<span>      mean_signal_to_noise <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>/</span><span class='va'>length_CI</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>,</span>
<span>      .groups  <span class='op'>=</span> <span class='st'>"drop"</span></span>
<span>    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>      outcome <span class='op'>=</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_extract.html'>str_extract</a></span><span class='op'>(</span><span class='va'>formula</span>, <span class='st'>"^[^\\s~]+(?=\\s?~)"</span><span class='op'>)</span>,</span>
<span>      n_days <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>n_days</span><span class='op'>)</span>,</span>
<span>      n_cities <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>n_cities</span><span class='op'>)</span></span>
<span>    <span class='op'>)</span></span>
<span><span class='op'>}</span> </span></code></pre>
</div>
</div>
<p>We then run this function.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>summary_evol_large</span> <span class='op'>&lt;-</span> <span class='fu'>summarise_simulations</span><span class='op'>(</span><span class='va'>sim_evol_large</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>outcome <span class='op'>=</span> <span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_relevel.html'>fct_relevel</a></span><span class='op'>(</span><span class='va'>outcome</span>, <span class='st'>"copd_age_65_75"</span>, <span class='st'>"resp_total"</span>, <span class='st'>"death_total"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(summary_evol_large, here("R", "Outputs", "summary_evol_large.RDS"))</span></span></code></pre>
</div>
</div>
<h3 id="small-number-of-observations">Small number of observations</h3>
<p>We then replicate this analysis for a smaller and more realistic baseline number of observations (10 cities and 1000 days).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_base_small</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  n_days <span class='op'>=</span> <span class='fl'>1000</span>,</span>
<span>  n_cities <span class='op'>=</span> <span class='fl'>10</span>,</span>
<span>  p_obs_treat <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  percent_effect_size <span class='op'>=</span> <span class='fl'>1</span>, </span>
<span>  iv_strength <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  formula <span class='op'>=</span> <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_unique_small</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map_dfr.html'>map_dfr</a></span><span class='op'>(</span></span>
<span>    <span class='va'>vect_of_vect_param</span>, </span>
<span>    <span class='va'>add_values_param</span>, </span>
<span>    df <span class='op'>=</span> <span class='va'>sim_param_base</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span><span class='va'>sim_param_evol_small</span> <span class='op'>&lt;-</span> <span class='fu'>prepare_sim_param</span><span class='op'>(</span><span class='va'>sim_param_unique_small</span>, n_iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"RDD"</span> <span class='op'>&amp;</span> <span class='va'>p_obs_treat</span> <span class='op'>&lt;=</span> <span class='fl'>0.01</span><span class='op'>)</span><span class='op'>)</span> </span>
<span></span>
<span><span class='va'>sim_evol_small</span> <span class='op'>&lt;-</span> <span class='fu'>run_all_sim</span><span class='op'>(</span><span class='va'>nmmaps_data</span>, <span class='va'>sim_param_evol_small</span>, save_every <span class='op'>=</span> <span class='fl'>10</span>, <span class='st'>"sim_evol_small"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(sim_evol_small, here("R", "Outputs", "sim_evol_small.RDS"))</span></span>
<span></span>
<span><span class='va'>summary_evol_small</span> <span class='op'>&lt;-</span> <span class='fu'>summarise_simulations</span><span class='op'>(</span><span class='va'>sim_evol_small</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>outcome <span class='op'>=</span> <span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_relevel.html'>fct_relevel</a></span><span class='op'>(</span><span class='va'>outcome</span>, <span class='st'>"copd_age_65_75"</span>, <span class='st'>"resp_total"</span>, <span class='st'>"death_total"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(summary_evol_small, here("R", "Outputs", "summary_evol_small.RDS"))</span></span></code></pre>
</div>
</div>
<h3 id="decomposing-the-number-of-observations-into-number-of-cities-and-days">Decomposing the number of observations into number of cities and days</h3>
<p>In this section, we wonder whether only the total number of observations maters or whether the ratio between number of cities and length of the study matters. We want to see whether decreasing the number of cities studied while keeping the number of observations constant (thus increasing the number of days) affects power and type M error. We thus run several simulations with an identical number of observations but different numbers of cities/days. We repeat this for 3 different number of observations (1000, 2000 and 4000) to check the robustness of our findings.</p>
<p>We first define the set of parameters:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_decomp_nobs</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>n_cities <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>3</span>, <span class='fl'>5</span>, <span class='fl'>10</span>, <span class='fl'>15</span>, <span class='fl'>25</span>, <span class='fl'>34</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>n_obs <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1000</span>, <span class='fl'>2000</span>, <span class='fl'>3000</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>n_days <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n_obs</span><span class='op'>/</span><span class='va'>n_cities</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>n_obs</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>full_join</a></span><span class='op'>(</span><span class='va'>sim_param_base</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"n_cities"</span>, <span class='st'>"n_days"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, .direction <span class='op'>=</span> <span class='st'>"updown"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter-joins.html'>anti_join</a></span><span class='op'>(</span><span class='co'>#because sim_param_base not in the exact set of param we want here</span></span>
<span>    <span class='va'>sim_param_base</span>,</span>
<span>    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"n_cities"</span>, <span class='st'>"n_days"</span>, <span class='st'>"p_obs_treat"</span>, <span class='st'>"percent_effect_size"</span>, <span class='st'>"iv_strength"</span>, <span class='st'>"formula"</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'>prepare_sim_param</span><span class='op'>(</span>n_iter <span class='op'>=</span> <span class='fl'>1000</span><span class='op'>)</span> </span></code></pre>
</div>
</div>
<p>We then run the simulations.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_decomp_nobs</span> <span class='op'>&lt;-</span> <span class='fu'>run_all_sim</span><span class='op'>(</span><span class='va'>nmmaps_data</span>, <span class='va'>sim_param_decomp_nobs</span>, <span class='fl'>10000</span>, <span class='st'>"sim_decomp_nobs"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(sim_decomp_nobs, here("R", "Outputs", "sim_decomp_nobs.RDS"))</span></span>
<span></span>
<span><span class='va'>summary_decomp_nobs</span> <span class='op'>&lt;-</span> <span class='fu'>summarise_simulations</span><span class='op'>(</span><span class='va'>sim_decomp_nobs</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>decomp_var <span class='op'>=</span> <span class='st'>"n_obs"</span><span class='op'>)</span></span>
<span><span class='co'># saveRDS(summary_decomp_nobs, here("R", "Outputs", "summary_decomp_nobs.RDS"))</span></span></code></pre>
</div>
</div>
<h3 id="decomposing-the-number-of-treated-into-number-of-observations-and-proportion-of-treated">Decomposing the number of treated into number of observations and proportion of treated</h3>
<p>We now then want to test whether we can combine information about the proportion of treated and the number of observations (into the number of treated). To do so, we use a methodology analog to the previous one.</p>
<p>We first define the set of parameters:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_decomp_ptreat</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>p_obs_treat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.01</span>, <span class='fl'>0.025</span>, <span class='fl'>0.05</span>, <span class='fl'>0.1</span>, <span class='fl'>0.25</span>, <span class='fl'>0.5</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>n_treat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>500</span>, <span class='fl'>1000</span>, <span class='fl'>2000</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    n_obs <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n_treat</span><span class='op'>/</span><span class='va'>p_obs_treat</span><span class='op'>)</span>,</span>
<span>    n_cities <span class='op'>=</span> <span class='fl'>50</span>, <span class='co'>#needs to be big enough</span></span>
<span>    n_days <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n_obs</span><span class='op'>/</span><span class='va'>n_cities</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>n_obs</span>, <span class='op'>-</span><span class='va'>n_treat</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>full_join</a></span><span class='op'>(</span><span class='va'>sim_param_base</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"n_cities"</span>, <span class='st'>"n_days"</span>, <span class='st'>"p_obs_treat"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, .direction <span class='op'>=</span> <span class='st'>"updown"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter-joins.html'>anti_join</a></span><span class='op'>(</span><span class='co'>#because sim_param_base not in the exact set of param we want here</span></span>
<span>    <span class='va'>sim_param_base</span>,</span>
<span>    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"n_cities"</span>, <span class='st'>"n_days"</span>, <span class='st'>"p_obs_treat"</span>, <span class='st'>"percent_effect_size"</span>, <span class='st'>"iv_strength"</span>, <span class='st'>"formula"</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'>prepare_sim_param</span><span class='op'>(</span>n_iter <span class='op'>=</span> <span class='fl'>1000</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>!=</span> <span class='st'>"OLS"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We then run the simulations.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_decomp_ptreat</span> <span class='op'>&lt;-</span>  <span class='fu'>run_all_sim</span><span class='op'>(</span><span class='va'>nmmaps_data</span>, <span class='va'>sim_param_decomp_ptreat</span>, <span class='fl'>10000</span>, <span class='st'>"sim_decomp_ptreat"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(sim_decomp_ptreat, here("R", "Outputs", "sim_decomp_ptreat.RDS"))</span></span>
<span></span>
<span></span>
<span><span class='va'>summary_decomp_ptreat</span> <span class='op'>&lt;-</span> <span class='fu'>summarise_simulations</span><span class='op'>(</span><span class='va'>sim_decomp_ptreat</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>decomp_var <span class='op'>=</span> <span class='st'>"n_treat"</span><span class='op'>)</span></span>
<span><span class='co'># saveRDS(summary_decomp_ptreat, here("R", "Outputs", "summary_decomp_ptreat.RDS"))</span></span>
<span></span>
<span><span class='va'>summary_decomp</span> <span class='op'>&lt;-</span> <span class='va'>summary_decomp_nobs</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>summary_decomp_ptreat</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># saveRDS(summary_decomp, here("R", "Outputs", "summary_decomp.RDS"))</span></span></code></pre>
</div>
</div>
<h3 id="usual-values-in-the-literature">Usual values in the literature</h3>
<p>In previous simulations, we varied all parameters, choosing somehow arbitrary values for the base parameters. In this section, we pick base values from the literature, for each identification method.</p>
<h4 id="rdd">RDD</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_base_usual_RDD</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  n_days <span class='op'>=</span> <span class='fl'>3652</span>,</span>
<span>  n_cities <span class='op'>=</span> <span class='fl'>1</span>,</span>
<span>  p_obs_treat <span class='op'>=</span> <span class='fl'>0.012</span>, <span class='co'>#approximately 43/3652</span></span>
<span>  percent_effect_size <span class='op'>=</span> <span class='fl'>8</span>, </span>
<span>  iv_strength <span class='op'>=</span> <span class='cn'>NA</span>,</span>
<span>  formula <span class='op'>=</span> <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>vect_n_days</span> <span class='op'>&lt;-</span> <span class='fl'>3652</span></span>
<span><span class='va'>vect_p_obs_treat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.012</span>, <span class='fl'>0.02</span>, <span class='fl'>0.03</span>, <span class='fl'>0.04</span>, <span class='fl'>0.05</span>, <span class='fl'>0.1</span><span class='op'>)</span></span>
<span><span class='va'>vect_percent_effect_size</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span></span>
<span><span class='va'>vect_iv_strength</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span></span>
<span><span class='va'>vect_formula</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_unique_usual_RDD</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map_dfr.html'>map_dfr</a></span><span class='op'>(</span></span>
<span>    <span class='va'>vect_of_vect_param</span>, </span>
<span>    <span class='va'>add_values_param</span>, </span>
<span>    df <span class='op'>=</span> <span class='va'>sim_param_base_usual_RDD</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span><span class='va'>sim_param_unique_usual_RDD</span> <span class='op'>&lt;-</span> <span class='va'>sim_param_unique_usual_RDD</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>bibi <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>4</span>, <span class='fl'>6</span>, <span class='fl'>8</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>percent_effect_size</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>percent_effect_size <span class='op'>=</span> <span class='va'>bibi</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_evol_usual_RDD</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'>prepare_sim_param</span><span class='op'>(</span><span class='va'>sim_param_unique_usual_RDD</span>, n_iter <span class='op'>=</span> <span class='fl'>1000</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"RDD"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>p_obs_treat <span class='op'>=</span> <span class='va'>p_obs_treat</span><span class='op'>*</span><span class='fl'>5</span><span class='op'>)</span> <span class='co'>#Because divide by 5 in prepare_sim_param</span></span></code></pre>
</div>
</div>
<h4 id="reduced-form">Reduced form</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_base_usual_reduced</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  n_days <span class='op'>=</span> <span class='fl'>2200</span>,</span>
<span>  n_cities <span class='op'>=</span> <span class='fl'>5</span>,</span>
<span>  p_obs_treat <span class='op'>=</span> <span class='fl'>0.005</span>, <span class='co'>#57/(2200*5)</span></span>
<span>  percent_effect_size <span class='op'>=</span> <span class='fl'>34</span>, </span>
<span>  iv_strength <span class='op'>=</span> <span class='cn'>NA</span>,</span>
<span>  formula <span class='op'>=</span> <span class='st'>"copd_age_65_75 ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>vect_n_days</span> <span class='op'>&lt;-</span> <span class='fl'>2200</span></span>
<span><span class='va'>vect_p_obs_treat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.005</span>, <span class='fl'>0.01</span>, <span class='fl'>0.05</span>, <span class='fl'>0.1</span><span class='op'>)</span></span>
<span><span class='va'>vect_percent_effect_size</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span></span>
<span><span class='va'>vect_iv_strength</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span></span>
<span><span class='va'>vect_formula</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"copd_age_65_75 ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_unique_usual_reduced</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map_dfr.html'>map_dfr</a></span><span class='op'>(</span></span>
<span>    <span class='va'>vect_of_vect_param</span>, </span>
<span>    <span class='va'>add_values_param</span>, </span>
<span>    df <span class='op'>=</span> <span class='va'>sim_param_base_usual_reduced</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span></span>
<span><span class='va'>sim_param_unique_usual_reduced</span> <span class='op'>&lt;-</span> <span class='va'>sim_param_unique_usual_reduced</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>bibi <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>4</span>, <span class='fl'>8</span>, <span class='fl'>17</span>, <span class='fl'>34</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>percent_effect_size</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>percent_effect_size <span class='op'>=</span> <span class='va'>bibi</span><span class='op'>)</span></span>
<span></span>
<span></span>
<span><span class='va'>sim_param_evol_usual_reduced</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'>prepare_sim_param</span><span class='op'>(</span><span class='va'>sim_param_unique_usual_reduced</span>, n_iter <span class='op'>=</span> <span class='fl'>1000</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"reduced_form"</span><span class='op'>)</span> </span></code></pre>
</div>
</div>
<h4 id="iv">IV</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>sim_param_base_usual_IV</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  n_days <span class='op'>=</span> <span class='fl'>2500</span>,</span>
<span>  n_cities <span class='op'>=</span> <span class='fl'>40</span>,</span>
<span>  p_obs_treat <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  percent_effect_size <span class='op'>=</span> <span class='fl'>1.5</span>, </span>
<span>  iv_strength <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>  formula <span class='op'>=</span> <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>vect_n_days</span> <span class='op'>&lt;-</span> <span class='fl'>2500</span></span>
<span><span class='va'>vect_p_obs_treat</span> <span class='op'>&lt;-</span> <span class='fl'>0.5</span></span>
<span><span class='va'>vect_percent_effect_size</span> <span class='op'>&lt;-</span> <span class='fl'>1.5</span></span>
<span><span class='va'>vect_iv_strength</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.4</span>, by <span class='op'>=</span> <span class='fl'>0.1</span><span class='op'>)</span></span>
<span><span class='va'>vect_formula</span> <span class='op'>&lt;-</span> <span class='cn'>NA</span></span>
<span></span>
<span><span class='va'>sim_param_unique_usual_IV</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map_dfr.html'>map_dfr</a></span><span class='op'>(</span></span>
<span>    <span class='va'>vect_of_vect_param</span>, </span>
<span>    <span class='va'>add_values_param</span>, </span>
<span>    df <span class='op'>=</span> <span class='va'>sim_param_base_usual_IV</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span></span>
<span><span class='va'>sim_param_unique_usual_IV</span> <span class='op'>&lt;-</span> <span class='va'>sim_param_unique_usual_IV</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>bibi <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"death_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span>,</span>
<span>  <span class='st'>"resp_total ~ treated + temperature + temperature_squared | city + month^year + weekday"</span>,</span>
<span>  <span class='st'>"copd_age_65_75 ~ treated + temperature + temperature_squared | city + month^year + weekday"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>formula</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>formula <span class='op'>=</span> <span class='va'>bibi</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim_param_evol_usual_IV</span> <span class='op'>&lt;-</span> </span>
<span>  <span class='fu'>prepare_sim_param</span><span class='op'>(</span><span class='va'>sim_param_unique_usual_IV</span>, n_iter <span class='op'>=</span> <span class='fl'>1000</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>id_method</span> <span class='op'>==</span> <span class='st'>"IV"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="running-simulations">Running simulations</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># sim_param_evol_usual &lt;- sim_param_evol_usual_RDD %&gt;% </span></span>
<span><span class='co'>#   bind_rows(sim_param_evol_usual_reduced) %&gt;% </span></span>
<span><span class='co'>#   bind_rows(sim_param_evol_usual_IV)</span></span>
<span></span>
<span><span class='va'>sim_param_evol_usual</span> <span class='op'>&lt;-</span> <span class='va'>sim_param_evol_usual_IV</span></span>
<span></span>
<span><span class='va'>sim_evol_usual</span> <span class='op'>&lt;-</span> <span class='fu'>run_all_sim</span><span class='op'>(</span><span class='va'>nmmaps_data</span>, <span class='va'>sim_param_evol_usual</span>, save_every <span class='op'>=</span> <span class='fl'>20000</span>, name_save <span class='op'>=</span> <span class='st'>"sim_iv"</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>saveRDS</a></span><span class='op'>(</span><span class='va'>sim_evol_usual</span>, <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"simulations"</span>, <span class='st'>"sim_evol_usual_iv.RDS"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>summary_evol_usual</span> <span class='op'>&lt;-</span> <span class='fu'>summarise_simulations</span><span class='op'>(</span><span class='va'>sim_evol_usual</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>outcome <span class='op'>=</span> <span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_relevel.html'>fct_relevel</a></span><span class='op'>(</span><span class='va'>outcome</span>, <span class='st'>"copd_age_65_75"</span>, <span class='st'>"resp_total"</span>, <span class='st'>"death_total"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>saveRDS</a></span><span class='op'>(</span><span class='va'>summary_evol_usual</span>, <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"R"</span>, <span class='st'>"Outputs"</span>, <span class='st'>"summary_evol_usual.RDS"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
